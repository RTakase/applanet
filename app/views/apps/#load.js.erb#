

var plotData = [];
//表示するデータから必要な部分を抜き取る
<% @simapps.each_with_index do |simapp, i| %>;
var data = <%= simapp["similarity"].collect {|e| 1.0 - e } %>; //座標
if (data.length == 1) data.push(data[0]); //一次元のときのための補正
data.push(<%= simapp["distance"] %>); //円のサイズ
data.push("<%= i %>"); //ラベル
data.push("<%= simapp["packageid"] %>"); //あとでタイトルとかと紐付けするためのパッケージID(jqplotの仕様外）
plotData.push(data);
<% end %>;

var plotOp = {};
plotOp.seriesDefaults = {
    renderer: $.jqplot.BubbleRenderer,
    rendererOptions: {
        bubbleAlpha: 0.7,
        varyBubbleColors: true,
    }
};
plotOp.axesDefaults = {
    tickOptions: {
        formatString: '%0.2f',
    },
    //ticks: [-0.2,0,0.2,0.4,0.6,0.8,1.0],
};
plotOp.axes = {
    xaxis: {
        label: "<%= @charInfo[@checked[0]] %>"
    },
    yaxis: {
        labelRenderer: $.jqplot.CanvasAxisLabelRenderer,
        label: "<%= @checked.length >= 2 ? @charInfo[@checked[1]] : "" %>"
    }
};
plotOp.cursor = {
    show: true,
    zoom: true,
    showTooltip: false
};

//html中のid=chartなdivタグの中身をざくっと書き換える（てくれる）
$("#chart").empty();
var plot = $.jqplot("chart", [plotData], plotOp);
$("#chart").show(); 
$("#chart").off(); //紐付けられた全イベントを解除

//拡大した際にはみ出たバブル達を隠す（jqplotに報告してあげようかな）
$(".jqplot-series-canvas").css({overflow: "hidden"});

//バブルがマウスオーバーされたときにアプリの名前のツールチップを表示する
$('#chart').bind('jqplotDataHighlight', function (ev, seriesIndex, pointIndex, data, radius) {   
    //バブルの位置(data[0],data[1])をページ上の座標(x,y)に変換
    var x = plot.axes.xaxis.u2p(data[0]);
    var y = plot.axes.yaxis.u2p(data[1]);  // convert y axis units to pixels on grid
    var color = 'rgb(50%,50%,100%)';

    //ツールチップの位置を指定
    $('.jqplot-cursor-tooltip').css({left:x+radius+5, top:y-radius-5});

    //ツールチップの中身をアプリの名前（バブルチャートのラベル）に指定
    //data[4]は上のほうで勝手に設定したパッケージID
    var title = "";
     <% @simapps.each do |simapp| %>
       if (data[4] == "<%= simapp["packageid"] %>") {
       title = "<%= simapp["title"] %>"
       } 
    <% end %>
    $('.jqplot-cursor-tooltip')
       .html('<span style="font-size:14px;font-weight:bold;color:'+color+';">'+title+'</span>');

    $('.jqplot-cursor-tooltip').show();
});

$('#chart').bind('jqplotDataUnhighlight', function (ev, seriesIndex, pointIndex, data) {
    $('.jqplot-cursor-tooltip').empty();
    $('.jqplot-cursor-tooltip').hide();
});

//バブルがクリックされたときにそのアプリのウェブページに飛ばす
$('#chart').bind('jqplotDataClick',　function (ev, seriesIndex, pointIndex, data) {
    var url = "https://play.google.com/store/apps/details?id=" 
    + data[4] 
    + "&hl=ja";
    //data[4]は上のほうで勝手に設定したパッケージID
    window.open(url);
});

//部分テンプレートを呼び出す
//コントローラ内のインスタンス変数がなぜかここでは取得できない・・・
$("#msg").html("<%= j render(:partial => 'applink') %>");

